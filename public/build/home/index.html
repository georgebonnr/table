<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <title>Table | Reservations</title>
    <link href="../stylesheets/normalize.css" media="screen" rel="stylesheet" type="text/css" />
<link href="../stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="../scripts/all.js" type="text/javascript"></script>
  </head>

  <body class="home home_index">
    <nav>
  <div class="menu-wrapper">
    <div class="nav">
      <ul>
        <li><a href="index.html">Table</a></li>
        <li><a href="/logout">Sign Out</a></li>
        <li><a href="../account/">Account</a></li>
        <li><a href="../analytics/">Analytics</a></li>
        <li><a href="/home">Home</a></li>
      </ul>
    </div>
  </div>
</nav>

    <nav class="date-time">
  <ul>
      <li><input class="datePicker" type="date" name="date"></li>
      <li><a href="">Jump to today</a></li>
      <li><a href="">Morning</a></li>
      <li><a href="">Afternoon</a></li>
      <li><a href="">Evening</a></li>

<!--begin modal--!>
      <div class="modal">
        <label id="modalLabel" for="modal-1">
          <div class="js-btn">
            <li></li>
          </div>
        </label>
        <input class="modal-state" id="modal-1" type="checkbox" />
        <div class="modal-window">
          <label class="modal-bg" for="modal-1"></label>
          <div class="modal-inner reservations">
            <label class="modal-close" for="modal-1"></label>

            <!--begin form--!>
            <h1>Create a Reservation</h1>
            <form class="reservationInit">
              <fieldset>
               <input type="text" name="phone" placeholder="Find guest by phone (hint: 5's)">
               <input name="getGuest" type="submit" value="Lookup">
              </fieldset>
            </form>
            <div class='modal-notification'></div>

            <form class="reservationComplete">
              <fieldset>
               <input type="number" placeholder="Number of guests" class="inline">
              </fieldset>
             <input type="submit" class="inline">
            </form>
            <!--end form--!>
          </div>
        </div>
      </div>
    </div>
    <!--end modal--!>
  </ul>
</nav>

<div class="vertical-container">
  <div class="vertical-tabs">
    <div class="tabs">
      <a href="" class="tab active">12:00pm</a>
      
    </div>

      <div class="tab-container">
        <!-- <a href="" class="accordion-active accordion-heading" rel="tab1">5PM</a> -->
        <div class="tables" class="tab-content">
          <ul id="tables" class="tables">

          </ul>
        </div>
      </div>
    </div>
  </div>
<script>
  var client = {};
  var datePicker = $('.datePicker')[0];
  var hoursPicker = ['12:00am','12:30am','1:00am','1:30am','2:30am','3:00am',
  '3:30am','4:00am','4:30am','5:00am','5:30am','6:00am','6:30am','7:00am',
  '7:30am','8:00am','8:30am','9:00am','9:30am','10:00am','10:30am','11:00am',
  '11:30am','12:00pm','12:30pm','1:00pm','1:30pm','2:00pm','2:30pm','3:00pm','3:30pm',
  '4:00pm','4:30pm','5:00pm','5:30pm','6:00pm','6:30pm','7:00pm','7:30pm',
  '8:00pm','8:30pm','9:00pm','9:30pm','10:00pm','10:30pm','11:00pm','11:30pm']

  var $tabs = $('.tabs');

  $.ajax({
    url: "/api/v1/preferences",
    type: "GET",
  }).error(function(err){
    console.log(err);
  }).done(function(data){
    console.log('success',data);
    data = data.data ? data.data : data;
    if (data.hours){
      var start = hoursPicker.indexOf(data.hours.open);
      var end = hoursPicker.indexOf(data.hours.close);
      // for simplicity, ignoring restaurants that close in the AM
      $tabs[0].firstElementChild.text = data.hours.open;
      while (start <= end){
        start++;
        $tabs.append("<a href='' class='tab'>" + hoursPicker[start] + '</a>');
      }
    } else {
      var h1 = '<h1>No hours have been set for this organization â€“ unable to populate time picker</h1>'
    }
  })

  var $modalNotification = $('.modal-notification');

  function getDateTime(date, time){
    date = date.value.split('-');
    time.value = time.value || time.text;
    time = time.value.split(':');
    var isPm = time[1].slice(2);
    time[1] = time[1].slice(0,2);
    if (isPm === "pm" && time[0] < 12){
      time[0] = (parseInt(time[0],10) + 12).toString();
    }
    var result = {
      year: parseInt(date[0],10),
      month: parseInt(date[1],10),
      day: parseInt(date[2],10),
      hour: parseInt(time[0],10),
      minutes: parseInt(time[1],10)
    }
    return result;
  }

  Date.prototype.toDateInputValue = (function() {
      var local = new Date(this);
      local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
      console.log(local.toJSON());
      return local.toJSON().slice(0,10);
  });

  datePicker.value = (new Date().toDateInputValue());

  $tableContainer = $('#tables');
  var $tables;

  function makeTable(container, t){
    container.append('<li> <div id="' + t.name + '" class="table"><div>' + t.max + '</div><span>' + t.name + '</span></div></li>');
  }

  $.ajax({
    url: "/api/v1/tables",
    type: "GET"
  }).error(function(err){
    console.log(err);
  }).done(function(data){
    var tables = data.data;
    $tableContainer.html('');
    for (var i=0; i<tables.length; i++){
      makeTable($tableContainer, tables[i]);
    }
    $tables = $('.table');
    $('.tab.active').trigger('click');
  });

  $('.tabs').on('click', '.tab', function(e){
    e.preventDefault();
    var dateTime = getDateTime(datePicker, this);
    client.dateTime = target = new Date(dateTime.year, dateTime.month-1, dateTime.day, dateTime.hour, dateTime.minutes);
    var start = new Date(dateTime.year, dateTime.month-1, dateTime.day, dateTime.hour, dateTime.minutes);
    var end = new Date(dateTime.year, dateTime.month-1, dateTime.day, dateTime.hour, dateTime.minutes);
    start.setHours(target.getHours() - 2)
    end.setHours(target.getHours() + 2)
    $.ajax({
      url: "/api/v1/reservations",
      type: "GET",
      data: {
        start: start,
        end: end
      }
    }).error(function(err){
      console.log(err);
    }).done(function(data){
      $tables.removeClass('reserved');
      if (!data) {return console.log('no reservations for this period');}
      if (data.data) {data = data.data;}
      console.log('data',data);
      for (var i=0; i<data.length; i++){
        var tableId = '#' + data[i].table
        $(tableId).addClass('reserved');
      }
    });
  })

  var $modalNotification = $('.modal-notification');

  var $reservationInit;
  
  $('#tables').on('click', '.table:not(.reserved)', function (e) {
    $('.js-btn li').trigger('click');
    $('.modal-inner').addClass('reservationsModal');
    $reservationInit = $('.reservationInit');
    $reservationInit.data('table', e.currentTarget.lastElementChild.innerHTML);
    $reservationInit.data('capacity', parseInt(e.currentTarget.firstElementChild.innerHTML, 10));
    $reservationInit.data('dateTime', client.dateTime);
  });


  $('.reservationInit').on('submit', function(e){
    e.preventDefault();
    var phone = $(this)[0][1].value.replace(/\D/g,'');
    $.ajax({
      url: "/api/v1/users",
      type: "GET",
      data: {phone: phone}
    }).error(function(err){
      console.log(err);
    }).done(function(data){
      var person;
      if (data.data && data.data[0]){
        person = data.data[0];
        $reservationInit.html('')
        $reservationInit.append('<h1>' + person.firstName + ' ' + person.lastName +'</h1>')
        $reservationInit.data('person', person);
      } else {
        $modalNotification.text('number not found').finish().slideDown().delay(5000).slideUp();
      }
    });
  });

  $('.reservationComplete').on('submit', function(e){
    e.preventDefault();
    var size = this[1].valueAsNumber;
    if (size > $reservationInit.data('capacity')) {
      return $modalNotification.html('table does not have capacity').finish().slideDown().delay(5000).slideUp();
    }
    $.ajax({
        url: "/api/v1/reservations",
        type: "POST",
        data: {
          email: $reservationInit.data('person').email,
          phone: $reservationInit.data('person').phone,
          time: $reservationInit.data('dateTime'),
          size: size,
          table: $reservationInit.data('table')
        }
      }).error(function(err){
        console.log(err);
        $modalNotification.html(err.responseText).finish().slideDown().delay(5000).slideUp();
      }).done(function(data){
        console.log('success',data);
        $reservationInit = null;
        $('.modal-close').trigger('click');
        $('.tab.active').trigger('click');
      })
  })

  $(".tab-content").show();

  /* if in tab mode */
  $(".tabs").on('click', '.tab', function() {
    event.preventDefault()
    var activeTab = $(this).attr("rel");  
    $(".tabs .tab").removeClass("active");
    $(this).addClass("active");

    $(".accordion-heading").removeClass("accordion-active");
    $(".accordion-heading[rel^='"+activeTab+"']").addClass("accordion-active");

  });
  /* if in accordion mode */
  $(".accordion-heading").click(function() {
    event.preventDefault()

    $(".tab-content").hide();
    var accordion_activeTab = $(this).attr("rel"); 
    $("#"+accordion_activeTab).show();

    $(".accordion-heading").removeClass("accordion-active");
    $(this).addClass("accordion-active");

    $(".tabs .tab").removeClass("active");
    $(".tabs .tab[rel^='"+accordion_activeTab+"']").addClass("active");
  });
</script>






















  </body>
</html>
