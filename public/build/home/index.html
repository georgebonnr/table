<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <title>Table | Reservations</title>
    <link href="../stylesheets/normalize.css" media="screen" rel="stylesheet" type="text/css" />
<link href="../stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="../scripts/all.js" type="text/javascript"></script>
  </head>

  <body class="home home_index">
    <nav>
  <div class="menu-wrapper">
    <div class="nav">
      <ul>
        <li><a href="index.html">Table</a></li>
        <li><a href="/logout">Sign Out</a></li>
        <li><a href="../account/">Account</a></li>
        <li><a href="../analytics/">Analytics</a></li>
        <li><a href="/home">Home</a></li>
      </ul>
    </div>
  </div>
</nav>

    <nav class="date-time">
  <ul>
      <li><input class="datePicker" type="date" name="date"></li>
      <li><a href="">Jump to today</a></li>
      <li><a href="">Morning</a></li>
      <li><a href="">Afternoon</a></li>
      <li><a href="">Evening</a></li>
</nav>



<!--begin modal--!>
      <div class="modal">
        <label id="modalLabel" for="modal-1">
          <div class="js-btn">
            <li></li>
          </div>
        </label>
        <input class="modal-state" id="modal-1" type="checkbox" />
        <div class="modal-window">
          <label class="modal-bg" for="modal-1"></label>
          <div class="modal-inner reservations">
            <label class="modal-close" for="modal-1"></label>

            <!--begin form--!>
            <h1>Create a Reservation</h1>
            <form class="phoneForm">
              <fieldset>
               <input type="text" name="phone" placeholder="Find guest by phone (hint: 5's)">
               <input name="getGuest" type="submit" value="Lookup">
              </fieldset>
            </form>
            <div class='modal-notification'></div>

            <form class="reservationDetails">
              <fieldset>
               <label>Reservation for:</label>
               <input type="date" class="inline">
               <input type="time" class="inline">
               <input type="number" placeholder="Number of guests" class="inline">
              </fieldset>
             <input type="submit" class="inline">
            </form>
            <div class='modal-notification'></div>
            <!--end form--!>

            <div class='modal-notification'></div>
          </div>
        </div>
      </div>
    </div>
    <!--end modal--!>
  </ul>
</nav>

<div class="vertical-container">
  <div class="vertical-tabs">
    <div class="tabs">
      <a href="" class="tab active">12:00pm</a>
      
    </div>

    <div class="tab-container">
        <!-- <a href="" class="accordion-active accordion-heading" rel="tab1">5PM</a> -->
        <div class="tables" class="tab-content">
          <ul id="tables" class="tables">

          </ul>
<script>
  var hoursPicker = ['12:00am','12:30am','1:00am','1:30am','2:30am','3:00am',
  '3:30am','4:00am','4:30am','5:00am','5:30am','6:00am','6:30am','7:00am',
  '7:30am','8:00am','8:30am','9:00am','9:30am','10:00am','10:30am','11:00am',
  '11:30am','12:00pm','12:30pm','1:00pm','1:30pm','2:30pm','3:00pm','3:30pm',
  '4:00pm','4:30pm','5:00pm','5:30pm','6:00pm','6:30pm','7:00pm','7:30pm',
  '8:00pm','8:30pm','9:00pm','9:30pm','10:00pm','10:30pm','11:00pm','11:30pm']

  var $tabs = $('.tabs');
  $.ajax({
    url: "/api/v1/preferences",
    type: "GET",
  }).error(function(err){
    console.log(err);
  }).done(function(data){
    console.log('success',data);
    data = data.data ? data.data : data;
    if (data.hours){
      var start = hoursPicker.indexOf(data.hours.open);
      var end = hoursPicker.indexOf(data.hours.close);
      // for simplicity, ignoring restaurants that close in the AM
      $tabs[0].firstElementChild.text = data.hours.open;
      while (start <= end){
        start++;
        $tabs.append("<a href='' class='tab'>" + hoursPicker[start] + '</a>');
      }
    } else {
      var h1 = '<h1>No Opening Hours Entered for this organization â€“ unable to populate time picker</h1>'
    }
  })


  $('.tab.active').trigger('click');
  var $modalNotification = $('.modal-notification');

  var currentPerson, currentTable, capacity;
  $('.reservationDetails').on('submit', function(e){
    e.preventDefault();
    var $this = $(this);
    var date = $($this[0][1]);
    var time = $($this[0][2]);
    var size = $($this[0][3])[0].value;
    if (size > capacity) {
      $modalNotification.html('table does not have capacity').finish().slideDown().delay(5000).slideUp();
    }
    var sample = getDateTime(date,time);
    var target = new Date(sample.year, sample.month-1, sample.day, sample.hour, sample.minutes);
    target = target.toISOString();
    $.ajax({
        url: "/api/v1/reservations",
        type: "POST",
        data: {
          email: currentPerson.email,
          phone: currentPerson.phone,
          time: target,
          size: size,
          table: currentTable
        }
      }).error(function(err){
        console.log(err);
        $modalNotification.html(err.responseText).finish().slideDown().delay(5000).slideUp();
      }).done(function(data){
        console.log('success',data);
        $('.modal-close').trigger('click');
        $('.tab.active').trigger('click');
      })
  })
  function getDateTime(picker,time){
    var route;
    if (picker) {route = true;}
    var date = picker || $('.datePicker')
    time = time || $('.tab.active')
    if (route){
      date = date[0].value.split('-');
    } else {
      date = date.val().split('-');
    }
    if (route){
      time = time[0].value.split(':');
    } else {
      time = time.html().split(':');
    }
    var pm = time[1].slice(2);
    time[1] = time[1].slice(0,2);
    if (pm === "pm" && time[0] < 12){
      time[0] = (parseInt(time[0],10) + 12).toString();
    }
    var result = {
      year: parseInt(date[0],10),
      month: parseInt(date[1],10),
      day: parseInt(date[2],10),
      hour: parseInt(time[0],10),
      minutes: parseInt(time[1],10)
    }
    return result;
  }
  Date.prototype.toDateInputValue = (function() {
      var local = new Date(this);
      local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
      return local.toJSON().slice(0,10);
  });

  $('.datePicker').val(new Date().toDateInputValue());
  $tables = $('#tables');

  function makeTable(container, t){
    container.append('<li> <div class="table available"><span>' + t.max + '</span><br><span class="name">' + t.name + '</span></div></li>');
  }

  $.ajax({
    url: "/api/v1/tables",
    type: "GET"
  }).error(function(err){
    console.log(err);
  }).done(function(data){
    var tables = data.data;
    $tables.html('');
    for (var i=0; i<tables.length; i++){
      makeTable($tables, tables[i]);
    }
  });

  function applyToTable($table){
    $table.removeClass('available');
    $table.removeClass('reserved');
    $table.addClass('reserved');
  }

  $('.tabs').on('click', '.tab', '.tab.active', function(e){
    // e.preventDefault();
    var dateTime = getDateTime();
    var startMinutes = 30;
    var endMinutes = 0;
    if (dateTime.minutes == 30){
      startMinutes = endMinutes;
      endMinutes = startMinutes;
    }
    var target = new Date(dateTime.year, dateTime.month-1, dateTime.day, dateTime.hour, dateTime.minutes);
    var start = new Date(dateTime.year, dateTime.month-1, dateTime.day, dateTime.hour, dateTime.minutes);
    var end = new Date(dateTime.year, dateTime.month-1, dateTime.day, dateTime.hour, dateTime.minutes);
    start.setHours(target.getHours() - 2)
    start = start.toISOString();
    end.setHours(target.getHours() + 2)
    end = end.toISOString();
    $.ajax({
      url: "/api/v1/reservations",
      type: "GET",
      data: {
        start: start,
        end: end
      }
    }).error(function(err){
      console.log(err);
    }).done(function(data){
      var $tableDivs = $('.table');
      console.log('before',$tableDivs);
      $tableDivs.removeClass('reserved');
      $tableDivs.addClass('available');
      console.log('after',$tableDivs);

      if (!data) {return console.log('no reservations for this period');}
      data = data.data;
      for (var i=0; i<data.length; i++){
        var $table = $tableDivs.filter(function(index){
          return $(this).find('span.name').html() === data[i].table;
        })
        console.log($table);
        applyToTable($table);
      }
    });
  })

  var $modalNotification = $('.modal-notification');

  $('#tables').on('click', '.table.available', function (e) {
    console.log(e.currentTarget);
    capacity = e.currentTarget.firstElementChild.innerHTML;
    currentTable = e.currentTarget.lastElementChild.innerHTML
    $('.js-btn li').trigger('click');
    $('.modal-inner').addClass('reservationsModal');
  });

  var $phoneForm = $('.phoneForm');

  $phoneForm.on('submit', function(e){
    e.preventDefault();
    var phone = $(this)[0][1].value.replace(/\D/g,'');

    $.ajax({
      url: "/api/v1/users",
      type: "GET",
      data: {phone: phone}
    }).error(function(err){
      console.log(err);
    }).done(function(data){
      var person;
      if (data.data && data.data[0]){
        person = data.data[0];
        $phoneForm.html('')
        $phoneForm.append('<h1>' + person.firstName + ' ' + person.lastName +'</h1>')
        currentPerson = person;
      } else {
        $modalNotification.text('number not found').finish().slideDown().delay(5000).slideUp();
      }
    });
  });

  $(".tab-content").show();

  /* if in tab mode */
  $(".tabs").on('click', '.tab', function() {
    event.preventDefault()

    var activeTab = $(this).attr("rel");  

    $(".tabs .tab").removeClass("active");
    $(this).addClass("active");

    $(".accordion-heading").removeClass("accordion-active");
    $(".accordion-heading[rel^='"+activeTab+"']").addClass("accordion-active");

  });
  /* if in accordion mode */
  $(".accordion-heading").click(function() {
    event.preventDefault()

    $(".tab-content").hide();
    var accordion_activeTab = $(this).attr("rel"); 
    $("#"+accordion_activeTab).show();

    $(".accordion-heading").removeClass("accordion-active");
    $(this).addClass("accordion-active");

    $(".tabs .tab").removeClass("active");
    $(".tabs .tab[rel^='"+accordion_activeTab+"']").addClass("active");
  });
</script>






















  </body>
</html>
